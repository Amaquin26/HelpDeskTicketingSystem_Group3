@{
    ViewData["Title"] = "Ticket Page";
}
@model IEnumerable<ASI.Basecode.Services.Dto.TicketDto>

<!-- Main Content -->
<div class="content p-4" style="margin-left: 200px;">
    <h3 class="mb-4"><strong>Ticket Management</strong></h3>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Search Input -->
        <input type="text" id="searchInput" class="form-control me-2" placeholder="Search Tickets" style="flex: 1;">

        <!-- Add Ticket Button -->
        <a asp-action="AddTicket" asp-controller="Ticket" class="btn btn-success">Add Ticket</a>
    </div>

    <!-- Dynamic Tickets List Table -->
    <div id="ticketList" class="table-responsive">
        <table id="ticketTable" class="table table-bordered table-hover">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Issue</th>
                    <th scope="col">Created By</th>
                    <th scope="col">Category</th>
                    <th scope="col">Priority</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody id="ticketItems"></tbody>
        </table>
    </div>

    <!-- Pagination Controls -->
    <nav>
        <ul id="pagination" class="pagination justify-content-center"></ul>
    </nav>
</div>

<!-- Delete Ticket Modal -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteTicketModalLabel">Delete Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this ticket?</p>
                <p><strong>Ticket ID# </strong><span id="ticketId"></span></p>
                <p><strong>Status: </strong><span class="status"></span></p>
                <p><strong>Priority: </strong><span class="priority"></span></p>
                <p><strong>Category: </strong><span class="category"></span></p>
                <button type="button" class="btn btn-danger w-100">Delete Ticket</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>

    <script>
        $(document).ready(function () {
            var tickets = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model)); // Get data from the model
            var currentPage = 1;
            var itemsPerPage = 20;

            // Function to get pill classes based on status
            function getStatusPillClass(status) {
                switch (status.toLowerCase()) {
                    case 'open':
                        return 'badge text-danger';
                    case 'in progress':
                        return 'badge text-success';
                    case 'resolved':
                        return 'badge text-secondary';
                    case 'closed':
                        return 'badge text-dark';
                    case 'on hold':
                        return 'badge text-warning';
                    default:
                        return 'badge text-secondary';
                }
            }

            // Function to get label classes based on priority
            function getPriorityLabelClass(priority) {
                switch (priority.toLowerCase()) {
                    case 'low':
                        return 'badge rounded-pill bg-light my-1 text-secondary';
                    case 'medium':
                        return 'badge rounded-pill bg-secondary my-1';
                    case 'high':
                        return 'badge rounded-pill bg-warning my-1';
                    case 'critical':
                        return 'badge rounded-pill bg-danger my-1';
                    default:
                        return 'badge rounded-pill bg-danger my-1';
                }
            }

            // Function to display tickets
            function displayTickets(ticketsToShow) {
                var ticketItems = $('#ticketItems');
                ticketItems.empty(); // Clear previous tickets

                ticketsToShow.forEach(function (ticket) {
                    var row = `
                                        <tr>
                                            <td>${ticket.TicketId}</td>
                                            <td>${ticket.Description}</td>
                                            <td>${ticket.CreatedBy}</td>
                                            <td>${ticket.CategoryName}</td>
                                            <td><span class="${getPriorityLabelClass(ticket.PriorityName)}">${ticket.PriorityName}</span></td>
                                            <td><span class="${getStatusPillClass(ticket.StatusName)}">${ticket.StatusName}</span></td>
                                            <td class="text-center">
                                                <a href="/Ticket/${ticket.TicketId}" class="edit btn btn-outline-primary btn-sm"><i class="fas fa-eye"></i></a>
                                                <a href="/Ticket/EditTicket?ticketId=${ticket.TicketId}" class="edit btn btn-outline-success btn-sm"><i class="fas fa-edit"></i></a>
                                                <a href="#" class="edit btn btn-outline-danger btn-sm delete-btn" data-bs-toggle="modal" data-bs-target="#deleteTicketModal" data-ticket-id="${ticket.TicketId}" data-ticket-status="${ticket.StatusName}" data-ticket-priority="${ticket.PriorityName}" data-ticket-category="${ticket.CategoryName}">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </td>
                                        </tr>`;
                    ticketItems.append(row);
                });
            }

            // Function to handle pagination
            function paginate(tickets, page, itemsPerPage) {
                var start = (page - 1) * itemsPerPage;
                var end = start + itemsPerPage;
                return tickets.slice(start, end);
            }

            // Function to create pagination buttons
            function createPagination(totalItems, itemsPerPage) {
                var totalPages = Math.ceil(totalItems / itemsPerPage);
                var pagination = $('#pagination');
                pagination.empty(); // Clear previous pagination

                for (var i = 1; i <= totalPages; i++) {
                    var pageItem = `
                                        <li class="page-item">
                                            <a class="page-link${i === currentPage ? ' bg-danger text-white' : ' text-success'}" href="#" data-page="${i}">${i}</a>
                                        </li>`;
                    pagination.append(pageItem);
                }

                // Add click event to page buttons
                $('.page-link').click(function (e) {
                    e.preventDefault();
                    currentPage = parseInt($(this).data('page'));
                    var paginatedTickets = paginate(tickets, currentPage, itemsPerPage);
                    displayTickets(paginatedTickets);
                    createPagination(tickets.length, itemsPerPage);
                });
            }

            // Function to filter tickets based on search input
            function filterTickets(searchTerm) {
                return tickets.filter(ticket =>
                    ticket.Description.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ticket.CreatedBy.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ticket.CategoryName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ticket.PriorityName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    ticket.StatusName.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Event listener for search input
            $('#searchInput').on('keyup', function () {
                var searchTerm = $(this).val();
                var filteredTickets = filterTickets(searchTerm);
                currentPage = 1; // Reset to first page on search
                var paginatedTickets = paginate(filteredTickets, currentPage, itemsPerPage);
                displayTickets(paginatedTickets);
                createPagination(filteredTickets.length, itemsPerPage);
            });

            // Initial display
            var paginatedTickets = paginate(tickets, currentPage, itemsPerPage);
            displayTickets(paginatedTickets);
            createPagination(tickets.length, itemsPerPage);
        });
    </script>
}
